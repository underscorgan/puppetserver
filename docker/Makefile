NAMESPACE ?= puppet
git_describe = $(shell git describe)
vcs_ref := $(shell git rev-parse HEAD)
build_date := $(shell date -u +%FT%T)
hadolint_available := $(shell hadolint --help > /dev/null 2>&1; echo $$?)
hadolint_command := hadolint --ignore DL3008 --ignore DL3018 --ignore DL4000 --ignore DL4001
hadolint_container := hadolint/hadolint:latest

ifeq ($(IS_NIGHTLY),true)
	dockerfile := Dockerfile.nightly
	version := puppet6-nightly
	ifeq ($(PUPPERWARE_ANALYTICS_STREAM),production)
	  PUPPERWARE_ANALYTICS_STREAM = nightly-production
  else
	  PUPPERWARE_ANALYTICS_STREAM = nightly-dev
	endif
else
	version = $(shell echo $(git_describe) | sed 's/-.*//')
	dockerfile := Dockerfile
	PUPPERWARE_ANALYTICS_STREAM ?= dev
endif

prep:
ifneq ($(IS_NIGHTLY),true)
	@git fetch --unshallow ||:
	@git fetch origin 'refs/tags/*:refs/tags/*'
endif

lint:
ifeq ($(hadolint_available),0)
	@$(hadolint_command) puppetserver-standalone/$(dockerfile)
	@$(hadolint_command) puppetserver/$(dockerfile)
else
	@docker pull $(hadolint_container)
	@docker run --rm -v $(PWD)/puppetserver-standalone/$(dockerfile):/Dockerfile \
		-i $(hadolint_container) $(hadolint_command) Dockerfile
	@docker run --rm -v $(PWD)/puppetserver/$(dockerfile):/Dockerfile \
		-i $(hadolint_container) $(hadolint_command) Dockerfile
endif

build: prep
	@docker build \
		--pull \
		--build-arg vcs_ref=$(vcs_ref) \
		--build-arg build_date=$(build_date) \
		--build-arg version=$(version) \
		--build-arg pupperware_analytics_stream=$(PUPPERWARE_ANALYTICS_STREAM) \
		--file puppetserver-standalone/$(dockerfile) \
		--tag $(NAMESPACE)/puppetserver-standalone:$(version) \
		puppetserver-standalone
	@docker build \
		--build-arg namespace=$(NAMESPACE) \
		--build-arg vcs_ref=$(vcs_ref) \
		--build-arg build_date=$(build_date) \
		--build-arg version=$(version) \
		--build-arg pupperware_analytics_stream=$(PUPPERWARE_ANALYTICS_STREAM) \
		--file puppetserver/$(dockerfile) \
		--tag $(NAMESPACE)/puppetserver:$(version) \
		puppetserver
ifeq ($(IS_LATEST),true)
	@docker tag $(NAMESPACE)/puppetserver-standalone:$(version) \
		$(NAMESPACE)/puppetserver-standalone:latest
	@docker tag $(NAMESPACE)/puppetserver:$(version) \
		$(NAMESPACE)/puppetserver:latest
endif

test: prep
	@bundle install --path .bundle/gems
	@PUPPET_TEST_DOCKER_IMAGE=$(NAMESPACE)/puppetserver-standalone:$(version) \
		bundle exec rspec --options puppetserver-standalone/.rspec spec
	@PUPPET_TEST_DOCKER_IMAGE=$(NAMESPACE)/puppetserver:$(version) \
		bundle exec rspec --options puppetserver/.rspec spec

publish: prep
	@docker push $(NAMESPACE)/puppetserver-standalone:$(version)
	@docker push $(NAMESPACE)/puppetserver:$(version)
ifeq ($(IS_LATEST),true)
	@docker push $(NAMESPACE)/puppetserver-standalone:latest
	@docker push $(NAMESPACE)/puppetserver:latest
endif

.PHONY: lint build test publish
